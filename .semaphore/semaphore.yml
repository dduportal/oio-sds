version: v1.0
name: First pipeline
agent:
  machine:
    type: e1-standard-4 # 4 CPU 8 GB
    os_image: ubuntu1804
blocks:
  - name: Build
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: load docker Cache
          commands:
            - ls ./docker-cache || true
            - time cache restore $SEMAPHORE_PROJECT_NAME-docker-cache
            - ls ./docker-cache || true
            - docker image ls
            - time docker load -i ./docker-cache/build-py2.tar
            - docker image ls
        - name: build with docker
          commands:
            - time docker build --cache-from=sds-build-py2 --tag=sds-build-py2 --target=build-py2 ./
        - name: save docker cache
          commands:
            - time docker save -o ./docker-cache/build-py2.tar sds-build-py2
            - time cache store $SEMAPHORE_PROJECT_NAME-docker-cache

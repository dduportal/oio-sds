version: v1.0
name: First pipeline
agent:
  machine:
    type: e1-standard-4 # 4 CPU 8 GB
    os_image: ubuntu1804
blocks:
  - name: Build
    task:
      prologue:
        commands:
          - checkout
      env_vars:
        - name: IMAGE_NAME
          value: sds-build-py2
        - name: CACHE_DIR
          value: ./docker-cache
        - name: IMAGE_CACHE_FILE
          value: ./docker-cache/sds-build-py2.dockerimage
        - name: DOCKER_BUILDKIT
          value: 1
      jobs:
        - name: load docker Cache
          commands:
            - mkdir -p "${CACHE_DIR}"
            - time cache restore $SEMAPHORE_PROJECT_NAME-docker-cache
            - ls "${CACHE_DIR}"
            - docker image ls
            - time docker load -i "${IMAGE_CACHE_FILE}" || true
            - docker image ls
        - name: build with docker
          commands:
            - export DOCKER_BUILDKIT=1
            - time docker build --cache-from=${IMAGE_NAME} --tag=${IMAGE_NAME} --target=build-py2 ./
        - name: save docker cache
          commands:
            - time docker save -o "${IMAGE_CACHE_FILE}" ${IMAGE_NAME}
            - time cache store $SEMAPHORE_PROJECT_NAME-docker-cache
